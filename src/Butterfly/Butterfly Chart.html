<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Butterfly Chart — Pro</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --card-w:1400px;          /* allow the chart to span wider on large screens */
    --bg-grad:#000000;      /* default to dark; JS flips for light mode */
    --text:#f1f5f9;
    --muted:#cbd5e1;
    --panel:transparent;    /* chart sits directly on the page */
    --panel-border:transparent; /* no visible frame in dark mode */
    --grid:#000000;
    --axis:#000000;
    --shadow-1:none;
    --shadow-2:none;
  }
  :root[data-dark="true"]{
    --bg-grad:#000000;
    --text:#f1f5f9;
    --muted:#cbd5e1;
    --panel:transparent;
    --panel-border:transparent;
    --grid:#000000;
    --axis:#000000;
    --shadow-1:none;
    --shadow-2:none;
  }
  *{box-sizing:border-box}
  body{
    font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    margin:0; padding:28px 16px 52px; color:var(--text);
    background: var(--bg-grad);
  }
  @media (prefers-reduced-motion: reduce){
    body{ animation: none !important; }
  }
  @keyframes bgMove{
    0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
  }

  header{ max-width:var(--card-w); margin:0 auto 12px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  h1{ margin:0 0 2px; font-weight:800; letter-spacing:.2px; font-size:32px; flex:1 1 100%; }
  .toolbar{
    display:flex; gap:8px; flex-wrap:wrap; width:100%;
    margin-left:0;
  }
  .control{
    display:flex; gap:6px; align-items:center; background:transparent; border:none;
    padding:4px 0 4px 0;
    border-radius:0; box-shadow:none;
  }
  select, button, label.switch{
    font: 500 13px/1 'Poppins',sans-serif; color:var(--text);
  }
  select, button{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:10px;        
    height:30px;               
    padding:0 14px;            
    display:inline-flex;
    align-items:center;
    cursor:pointer;
    transition:.2s;
    box-shadow:0 1px 3px rgba(0,0,0,.08); 
  }
  
  select{
    padding-right:32px;
  }
  :root[data-dark="true"] select, :root[data-dark="true"] button{
    background:#000000; border-color:#4b5563; color:var(--text);
  }
  select:hover, button:hover{ transform:translateY(-1px); background:#f9fafb; box-shadow:0 4px 12px rgba(0,0,0,.08) }
  :root[data-dark="true"] select:hover, :root[data-dark="true"] button:hover{ background:#121632 }

  .switch{ user-select:none; cursor:pointer; }
  .switch input{ display:none }
  .switch .pill{
    width:44px; height:24px; border-radius:999px; background:#e5e7eb; position:relative; transition:.2s;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
  }
  :root[data-dark="true"] .switch .pill{ background:#24314a; }
  .switch .dot{
    position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition: transform .2s;
    box-shadow: 0 1px 3px rgba(0,0,0,.25);
  }
  .switch input:checked + .pill .dot{ transform: translateX(20px); }

  .panel{
    width:100%; max-width:var(--card-w); margin:10px auto 0; padding:0;
    border:none; border-radius:0; background:var(--panel);
    box-shadow:none; position:relative; overflow:visible;
  }
  #chart svg{ width:100%; height:auto; display:block; overflow:visible; }

  .axis-top text{ fill:var(--muted); font-size:12px; font-weight:600; font-family:'Poppins',sans-serif; }
  .axis-top .domain,.axis-top line{ stroke:var(--axis); }
  .age-label{ font-family:'Poppins',sans-serif; font-weight:700; fill:var(--text); }
  .axis-left text{ font-size:14px; }

  .leftG,.rightG{ will-change:transform; cursor:pointer; }
  .leftG:focus, .rightG:focus, .leftG rect:focus, .rightG rect:focus { outline: none; }
  .bar-left, .bar-right { pointer-events:auto; }
  .bead, .bar-left-ghost, .bar-right-ghost { pointer-events:none; }
  .grid line{ stroke:var(--grid); stroke-opacity:.35; stroke-width:0.6; }
  .grid .domain{ display:none; }

  /* Tooltip */
  #tip{
    position:fixed; top:0; left:0; transform:translate(12px,10px);
    background:#fff; color:var(--text); padding:12px 14px; border-radius:12px; font-size:14px; line-height:1.5;
    border:1px solid var(--panel-border);
    box-shadow: 0 10px 30px rgba(0,0,0,.10);
    pointer-events:none; opacity:0; transition:opacity .08s ease-out; z-index:1000;
  }
  :root[data-dark="true"] #tip{ background:#121526; color:#f1f5f9; border-color:#233042 }

  /* Visually-hidden for screen readers */
  .sr-only{
    position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important;
  }

  /* Main vs detail view toggling */
  #chart{
    transition: opacity .35s ease-out;
  }
  body[data-view="detail"] #chart{
    opacity:0; pointer-events:none;
    height:0; overflow:hidden;
  }
  #detailScreen{
    max-width:1100px;
    margin:48px auto 0;
    opacity:0; pointer-events:none;
    transition: opacity .35s ease-out;
  }
  body[data-view="detail"] #detailScreen{
    opacity:1; pointer-events:auto;
  }
  #detailHeaderRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;
  }
  #detailTitleFull{
    font-size:22px; font-weight:800;
  }
  #detailBack{
    border-radius:999px; border:1px solid var(--panel-border);
    background:var(--panel); color:var(--text);
    padding:4px 14px; font-size:12px; cursor:pointer;
  }
  #detailMetaFull{
    font-size:14px; color:var(--muted); margin-bottom:18px;
  }
  #detailBars{
    display:flex; flex-direction:column; gap:8px; margin-bottom:16px;
  }
  .detail-bar-row{
    display:flex; flex-direction:column; gap:4px;
  }
  .detail-bar-label{
    font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);
  }
  .detail-bar-track{
    width:100%; height:16px; border-radius:999px; background:rgba(148,163,184,.3); overflow:hidden;
  }
  .detail-bar-fill{
    height:100%; border-radius:999px;
  }
  .detail-bar-fill.left{ background:linear-gradient(to right,#9999FF,#9999FF); }
  .detail-bar-fill.right{ background:linear-gradient(to right,#FF9999,#FF9999); }
  #detailStatsGrid{
    display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px 16px; font-size:13px;
  }
  .detail-stat-label{
    font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);
  }
  .detail-stat-value{
    font-weight:700; font-size:15px;
  }

  /* Responsive */
  @media (max-width: 860px){
    h1{ font-size:26px }
    .control{ width:100%; }
  }
</style>
</head>
<body>
  <header aria-label="Butterfly chart controls">
    <h1>Butterfly Chart</h1>
    <div class="toolbar">
      <div class="control">
        <button id="sortBtn" aria-pressed="false" aria-label="Toggle sort order">Sort by Diff</button>
      </div>

    
    </div>
  </header>

  <!-- Status banner -->
  <div id="statusMsg" style="max-width:var(--card-w); margin:10px auto 0; font-size:12px; color:var(--muted); text-align:left;"></div>

  <!-- Info panel for hover -->


  <div id="chart" class="panel" role="group" aria-label="Male versus Female by age"></div>

  <div id="tip" role="status" aria-live="polite"></div>

  <div id="detailScreen" aria-live="polite" aria-label="Detail view for selected country">
    <div id="detailHeaderRow">
      <div id="detailTitleFull"></div>
      <button id="detailBack">Back to full chart</button>
    </div>
    <div id="detailMetaFull"></div>
    <div id="detailBars">
      <div class="detail-bar-row">
        <div class="detail-bar-label" id="detailLeftLabel"></div>
        <div class="detail-bar-track"><div class="detail-bar-fill left" id="detailLeftFill" style="width:0%"></div></div>
      </div>
      <div class="detail-bar-row">
        <div class="detail-bar-label" id="detailRightLabel"></div>
        <div class="detail-bar-track"><div class="detail-bar-fill right" id="detailRightFill" style="width:0%"></div></div>
      </div>
    </div>
    <div id="detailStatsGrid">
      <div>
        <div class="detail-stat-label" id="statLabelLeft"></div>
        <div class="detail-stat-value" id="statValueLeft"></div>
      </div>
      <div>
        <div class="detail-stat-label" id="statLabelRight"></div>
        <div class="detail-stat-value" id="statValueRight"></div>
      </div>
      <div>
        <div class="detail-stat-label">Total</div>
        <div class="detail-stat-value" id="statTotal"></div>
      </div>
      <div>
        <div class="detail-stat-label">Diff</div>
        <div class="detail-stat-value" id="statDiff"></div>
      </div>
      <div>
        <div class="detail-stat-label" id="statShareLabel"></div>
        <div class="detail-stat-value" id="statShare"></div>
      </div>
      <div>
        <div class="detail-stat-label">Diff rank</div>
        <div class="detail-stat-value" id="statRank"></div>
      </div>
    </div>
  </div>

<script>




/* ================================================ EDIT ONLY THIS SECTION ================================================ */
const labels = { left:'Exports', right:'Imports' };

const DATA_SOURCE = {
  type: 'csv',                    
  url: 'countries.csv',               
  categoryCol: 'country',             
  leftCol: 'exports',                 
  rightCol: 'imports',                
  rightScale: 1                       
};

const chartTitle = 'Exports vs Imports by Country';

const initialMode = 'dark';  // or 'light'

try{ document.querySelector('header h1').textContent = chartTitle; }catch(e){}
/* ============================================= DO NOT EDIT BELOW THIS LINE ============================================= */





function parseNum(v){
  if (v == null || v === '') return NaN;
  const cleaned = String(v).trim().replace(',', '.');
  const n = +cleaned;
  return Number.isNaN(n) ? NaN : n;
}

/* Loader: turn CSV/JSON into { age, male, female } rows. */
async function loadData() {
  try {
    if (!DATA_SOURCE || !DATA_SOURCE.url) {
      // No external data configured
      return [];
    }

    if (DATA_SOURCE.type === 'json') {
      const res = await fetch(DATA_SOURCE.url);
      const raw = await res.json();

      // If JSON already matches {age,male,female}, use as-is
      if (Array.isArray(raw) && raw.length &&
          raw[0].age != null && raw[0].male != null && raw[0].female != null) {
        return raw;
      }

      // Otherwise map using configured column names
      const s = DATA_SOURCE.rightScale || 1;
      return raw.map(r => ({
        age: r[DATA_SOURCE.categoryCol],
        male: parseNum(r[DATA_SOURCE.leftCol]),
        female: parseNum(r[DATA_SOURCE.rightCol]) * s
      }));
    }

    // CSV via d3
    const rows = await d3.csv(DATA_SOURCE.url);
    const s = DATA_SOURCE.rightScale || 1;
    let mapped = rows.map(r => ({
      age: r[DATA_SOURCE.categoryCol],
      male: parseNum(r[DATA_SOURCE.leftCol]),
      female: parseNum(r[DATA_SOURCE.rightCol]) * s
    })).filter(d => !Number.isNaN(d.male) && !Number.isNaN(d.female));

    const originalCount = mapped.length;
    // If there are many rows, keep only the top N by total so the chart
    // stays readable. Developers can change maxRows if they want more.
    const maxRows = 20;
    if (mapped.length > maxRows){
      mapped = mapped
        .sort((a,b) => (b.male + b.female) - (a.male + a.female))
        .slice(0, maxRows);
    }

    lastLoadInfo = { total: originalCount, shown: mapped.length };

    return mapped;
  } catch (err) {
    console.error('Data load failed, falling back to demoData:', err);
    return [];
  }
}

/* ---------------------- Themes (WCAG-conscious) ---------------------- */
const themes = {
  // Single palette: Purple (left) + Pink (right)
  DarkPG:  { left:["#9999FF","#9999FF"], right:["#FF9999","#FF9999"], bg:"#000000", text:"#f1f5f9" },
  LightPG: { left:["#9999FF","#9999FF"], right:["#FF9999","#FF9999"], bg:"#f6f7fb", text:"#0f172a" }
};

/* ---------------------- State ---------------------- */
const state = {
  data: [],
  year: null,
  theme: 'DarkPG',            // single palette (Purple + Pink)
  grid: false,
  showValues: false,
  sortByDiff: false
};

// Apply the developer-configured initialMode to choose the starting theme.
// Any non-'light' value falls back to the dark theme.
if (typeof initialMode === 'string'){
  const m = initialMode.toLowerCase();
  state.theme = m === 'light' ? 'LightPG' : 'DarkPG';
}

// Simple metadata about the current external dataset so we can explain
// when the chart is only showing the "top N" rows.
let lastLoadInfo = { total: 0, shown: 0 };

/* ---------------------- Mount & sizes ---------------------- */
const root = d3.select("#chart");
const W = Math.min(1180, root.node().clientWidth);
const H = Math.round(0.5 * W);
// Margins around the plotting area (extra left so labels have room to breathe)
const M = { top: 72, right: 26, bottom: 40, left: 170 };
const iw = W - M.left - M.right, ih = H - M.top - M.bottom;

const svg = root.append("svg")
  .attr("width", W).attr("height", H)
  .attr("viewBox", `0 0 ${W} ${H}`).attr("preserveAspectRatio","xMidYMid meet")
  .attr("role","img")
  .attr("aria-label","Butterfly chart comparing male and female values by age");

const g = svg.append("g").attr("transform", `translate(${M.left},${M.top})`);

// dynamic side labels (from the simple config above)
let sideLeftLabel = labels.left;
let sideRightLabel = labels.right;
let axisLeftTextNode = null;
let axisRightTextNode = null;

const defs = svg.append("defs");
// gradients (will be updated by theme)
const gradL = defs.append("linearGradient").attr("id","gradL").attr("x1","100%").attr("x2","0%");
gradL.selectAll("stop").data([0,1]).enter().append("stop").attr("offset", d=> (d*100)+"%").attr("stop-color", "#6b8bff");
const gradR = defs.append("linearGradient").attr("id","gradR").attr("x1","0%").attr("x2","100%");
gradR.selectAll("stop").data([0,1]).enter().append("stop").attr("offset", d=> (d*100)+"%").attr("stop-color", "#ff8c8c");

defs.append("filter").attr("id","softShadow")
  .attr("x","-20%").attr("y","-20%").attr("width","140%").attr("height","160%")
  .append("feDropShadow").attr("dx",0).attr("dy",1.6).attr("stdDeviation",1.8).attr("flood-opacity",0.22);

defs.append("filter").attr("id","softShadowHover")
  .attr("x","-30%").attr("y","-30%").attr("width","160%").attr("height","180%")
  .append("feDropShadow").attr("dx",0).attr("dy",3).attr("stdDeviation",3.2).attr("flood-opacity",0.28);

const highlight = defs.append("linearGradient").attr("id","barHighlight")
  .attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");
highlight.selectAll("stop").data([
  {o:"0%", c:"rgba(255,255,255,.35)"},
  {o:"25%", c:"rgba(255,255,255,.10)"},
  {o:"100%",c:"rgba(255,255,255,0)"},
]).enter().append("stop").attr("offset",d=>d.o).attr("stop-color",d=>d.c);

/* TOOLTIP/INFO BOX
   When you hover or focus with keyboard on a row, we show a tiny info box.
   The content adapts to which side of the butterfly you're over. */
const tip = d3.select("#tip");

function showTip(e, d, side){
  const total = d.male + d.female;
  const diff = Math.abs(d.male-d.female);

  let body = '';
  if (side === 'left'){
    body = `<div>${sideLeftLabel}: <b>${fmtShort(d.male)}</b></div>`;
  } else if (side === 'right'){
    body = `<div>${sideRightLabel}: <b>${fmtShort(d.female)}</b></div>`;
  } else {
    // Fallback (e.g., stacked mode): show both sides
    body = `<div>${sideLeftLabel}: <b>${fmtShort(d.male)}</b></div>
            <div>${sideRightLabel}: <b>${fmtShort(d.female)}</b></div>`;
  }

  tip.style('opacity',1)
     .html(`<div style="font-weight:700;margin-bottom:4px">${d.age}</div>
            ${body}`);
  moveTip(e);
};
function moveTip(e){
  const [mx,my] = d3.pointer(e, document.body);
  tip.style('transform', `translate(${mx+14}px,${my+14}px)`);
};
const hideTip = () => { tip.style('opacity',0); tip.text(''); };

/* SCALES & AXES
   These convert your numbers into pixel positions. No need to edit. */
function maxMF(data){ return d3.max(data, d => Math.max(d.male, d.female)); }
let maxVal = maxMF(state.data);
// Single symmetric scale centered at 0; left uses negative, right positive.
const xAll   = d3.scaleLinear().domain([-maxVal,maxVal]).range([0,iw]).clamp(true);
// Keep helpers for compatibility, but derive them from xAll so everything
// is guaranteed symmetric around xAll(0).
const xLeft  = d3.scaleLinear().domain([0,maxVal]).range([xAll(0), xAll(-maxVal)]).clamp(true);
const xRight = d3.scaleLinear().domain([0,maxVal]).range([xAll(0), xAll(maxVal)]).clamp(true);
// Vertical band scale: padding controls the space *between* rows/bars
// Slightly reduce padding so bars are taller and fill more of the SVG
const y      = d3.scaleBand().domain(state.data.map(d=>d.age)).range([18,ih]).padding(0.28);

// axes and grid layers
const gridG = g.append("g").attr("class","grid");
const axisTopG = g.append("g").attr("class","axis axis-top").attr("transform","translate(0,8)");
const axisLeftG = g.append("g").attr("class","axis axis-left");
// Side titles; exact x-position will be updated in drawAxes()
axisLeftTextNode = g.append("text")
  .attr("x", 0)
  .attr("y", -32)
  .attr("text-anchor","middle")
  .style("font-weight",700)
  .style("font-size","18px")
  .attr("fill","var(--muted)")
  .text(sideLeftLabel);
axisRightTextNode = g.append("text")
  .attr("x", iw)
  .attr("y", -32)
  .attr("text-anchor","middle")
  .style("font-weight",700)
  .style("font-size","18px")
  .attr("fill","var(--muted)")
  .text(sideRightLabel);
g.append("line").attr("x1",iw/2).attr("x2",iw/2).attr("y1",0).attr("y2",ih).attr("stroke","var(--axis)");

/* ---------------------- Layers ---------------------- */
const diffLayer = g.append("g").attr("aria-hidden","true");
const leftG = g.append("g").attr("class","left-layer");
const rightG = g.append("g").attr("class","right-layer");
const valueG = g.append("g").attr("class","value-layer");

/* ---------------------- Helpers ---------------------- */
const fmt = d3.format(".0f");
const fmtShort = d3.format("~s");

function setStatus(msg){
  const el=document.getElementById('statusMsg');
  el.textContent = msg || '';
}

function updateStatusMessage(){
  if (!lastLoadInfo || !lastLoadInfo.total) return;
  const modeText = state.sortByDiff
    ? 'by largest exports–imports gap.'
    : 'alphabetically by country.';
  setStatus(`Showing top ${lastLoadInfo.shown} of ${lastLoadInfo.total} countries ${modeText}`);
}

function openDetail(d){
  const titleEl = document.getElementById('detailTitleFull');
  const metaEl = document.getElementById('detailMetaFull');
  const leftLabelEl = document.getElementById('detailLeftLabel');
  const rightLabelEl = document.getElementById('detailRightLabel');
  const leftFill = document.getElementById('detailLeftFill');
  const rightFill = document.getElementById('detailRightFill');
  const statLabelLeft = document.getElementById('statLabelLeft');
  const statLabelRight = document.getElementById('statLabelRight');
  const statValueLeft = document.getElementById('statValueLeft');
  const statValueRight = document.getElementById('statValueRight');
  const statTotal = document.getElementById('statTotal');
  const statDiff = document.getElementById('statDiff');
  const statShareLabel = document.getElementById('statShareLabel');
  const statShare = document.getElementById('statShare');
  const statRank = document.getElementById('statRank');

  if (!titleEl) return;

  titleEl.textContent = d.age;

  // compute analytics
  const total = d.male + d.female;
  const diff = d.female - d.male; // right minus left
  const absDiff = Math.abs(diff);
  const percRight = total ? (d.female / total) * 100 : 0;
  const percDiff = total ? (absDiff / total) * 100 : 0;

  // rank by diff within current data
  const sortedByDiff = [...state.data].sort((a,b)=>Math.abs(b.male-b.female)-Math.abs(a.male-a.female));
  const rank = sortedByDiff.findIndex(x=>x.age===d.age) + 1;

  const sideLead = diff > 0 ? sideRightLabel : diff < 0 ? sideLeftLabel : 'Neither side';
  const leadText = diff === 0
    ? 'Both sides are equal here.'
    : `${sideLead} leads by ${fmtShort(absDiff)} (${percDiff.toFixed(1)}% of total).`;

  if (metaEl) metaEl.textContent = leadText;

  // simple two-bar graph: widths based on share of total
  const leftPct = total ? (d.male / total) * 100 : 0;
  const rightPct = total ? (d.female / total) * 100 : 0;

  if (leftLabelEl) leftLabelEl.textContent = `${sideLeftLabel} (${fmtShort(d.male)})`;
  if (rightLabelEl) rightLabelEl.textContent = `${sideRightLabel} (${fmtShort(d.female)})`;
  if (leftFill) leftFill.style.width = `${leftPct.toFixed(1)}%`;
  if (rightFill) rightFill.style.width = `${rightPct.toFixed(1)}%`;

  if (statLabelLeft) statLabelLeft.textContent = sideLeftLabel;
  if (statLabelRight) statLabelRight.textContent = sideRightLabel;
  if (statValueLeft) statValueLeft.textContent = fmtShort(d.male);
  if (statValueRight) statValueRight.textContent = fmtShort(d.female);
  if (statTotal) statTotal.textContent = fmtShort(total);
  if (statDiff) statDiff.textContent = `${diff > 0 ? '+' : diff < 0 ? '-' : ''}${fmtShort(absDiff)}`;
  if (statShareLabel) statShareLabel.textContent = `${sideRightLabel} share`;
  if (statShare) statShare.textContent = `${percRight.toFixed(1)}%`;
  if (statRank) statRank.textContent = `#${rank} by gap`;

  document.body.dataset.view = 'detail';
}
function closeDetail(){
  document.body.dataset.view = '';
}

// Note: CSV upload and column mapping removed for developer-focused usage.

// Mapping UI removed.
function updateTheme(name = state.theme, animate = true){
  const t = themes[name] || themes.LightSky;
  const dur = (animate && !window.matchMedia("(prefers-reduced-motion: reduce)").matches) ? 400 : 0;
  gradL.selectAll("stop").data(t.left).transition().duration(dur).attr("stop-color", d=>d);
  gradR.selectAll("stop").data(t.right).transition().duration(dur).attr("stop-color", d=>d);
  // Treat DarkMono and NightNeon as dark themes (we no longer use state.dark)
  const darkOn = /^Dark/.test(name);
  document.documentElement.dataset.dark = darkOn ? "true" : "false";
  if (darkOn){
    document.documentElement.style.setProperty('--text', '#f1f5f9');
    document.documentElement.style.setProperty('--bg-grad', '#000000'); // solid black
    document.documentElement.style.setProperty('--panel', 'transparent');
    document.documentElement.style.setProperty('--panel-border', 'transparent');
    document.documentElement.style.setProperty('--muted', '#ffffff');
    document.documentElement.style.setProperty('--axis', '#ffffff');
    document.documentElement.style.setProperty('--grid', '#111827');
    const card = document.getElementById('detailCard');
    const meta = document.getElementById('detailMeta');
    const closeBtn = document.getElementById('detailClose');
    if (card){
      card.style.background = '#000000';
      card.style.color = '#f9fafb';
      card.style.borderColor = '#555555';
    }
    if (meta){
      meta.style.color = '#e5e7eb';
    }
    if (closeBtn){
      closeBtn.style.background = '#000000';
      closeBtn.style.color = '#f1f5f9';
      closeBtn.style.borderColor = '#e5e7eb';
    }
  } else {
    document.documentElement.style.setProperty('--bg-grad', '#ffffff'); // solid white
    document.documentElement.style.setProperty('--panel', '#ffffff');
    document.documentElement.style.setProperty('--panel-border', 'transparent');
    document.documentElement.style.setProperty('--axis', '#111827');
    document.documentElement.style.setProperty('--grid', '#e5e7eb');
    document.documentElement.style.setProperty('--text', '#000000');
    document.documentElement.style.setProperty('--muted', '#111827');
    const card = document.getElementById('detailCard');
    const meta = document.getElementById('detailMeta');
    const closeBtn = document.getElementById('detailClose');
    if (card){
      card.style.background = '#ffffff';
      card.style.color = '#000000';
      card.style.borderColor = '#d1d5db';
    }
    if (meta){
      meta.style.color = '#4b5563';
    }
    if (closeBtn){
      closeBtn.style.background = '#ffffff';
      closeBtn.style.color = '#111827';
      closeBtn.style.borderColor = '#d1d5db';
    }
  }
}
function updateScales(){
  const baseMax = maxMF(state.data);
  maxVal = baseMax;
  xAll.domain([-maxVal,maxVal]);
  xLeft.domain([0,maxVal]).range([xAll(0), xAll(-maxVal)]);
  xRight.domain([0,maxVal]).range([xAll(0), xAll(maxVal)]);
  y.domain(state.data.map(d=>d.age));
}
function truncateLabel(name){
  const s = String(name || '').trim();
  return s.length > 20 ? s.slice(0, 20) + '…' : s;
}
function drawAxes(){
  // top numeric axis
  const step = 100;
  const maxRounded = Math.ceil(maxVal / step) * step;
  const ticks = d3.range(-maxRounded, maxRounded + step/2, step);
  axisTopG.call(
    d3.axisTop(xAll)
      .tickValues(ticks)
      .tickFormat(v => fmtShort(Math.abs(v)))
  );
  // Position side titles so they are centered over the outer 200 ticks
  if (axisLeftTextNode){
    axisLeftTextNode
      .attr("x", xAll(-maxVal) + 16)
      .attr("y", -32)
      .text(sideLeftLabel);
  }
  if (axisRightTextNode){
    axisRightTextNode
      .attr("x", xAll(maxVal) - 16)
      .attr("y", -32)
      .text(sideRightLabel);
  }
  // left category labels
  axisLeftG.attr("transform","translate(0,0)")
    .call(d3.axisLeft(y)
      .tickSize(0)
      .tickPadding(28)
      .tickFormat(truncateLabel)
    );
  axisLeftG.selectAll("path.domain").attr("display","none");
  axisLeftG.selectAll("text")
    .attr("fill","var(--muted)")
    .style("font-weight",600)
    .each(function(d){
      // Show full label on hover via native title tooltip
      const full = String(d || '').trim();
      if (!full) return;
      d3.select(this).selectAll('title').remove();
      d3.select(this).append('title').text(full);
    });
  // grid
  gridG.selectAll("*").remove();
  if (state.grid){
    const step = 100;
    const maxRounded = Math.ceil(maxVal / step) * step;
    const ticks = d3.range(-maxRounded, maxRounded + step/2, step);
    gridG
      .attr("transform", `translate(0,${ih})`)
      .call(
        d3.axisBottom(xAll)
          .tickValues(ticks)
          .tickSize(-ih)
          .tickFormat("")
      );
    gridG.selectAll(".domain").remove();
  }
}
function clearMode(){
  leftG.selectAll("*").remove();
  rightG.selectAll("*").remove();
  diffLayer.selectAll("*").remove();
  valueG.selectAll("*").remove();
}

/* DRAWING THE BARS
   This actually draws the shapes on the screen based on the data. */
function renderBars(){
  // diff glow
  // disable diff glow for flat style
  diffLayer.selectAll("*").remove();

  // Debug: log data count
  try{ console.debug('renderBars data', state.data?.length, 'maxVal', maxVal); }catch(e){}

  const leftRow = leftG.selectAll("g.leftG").data(state.data, d=>d.age)
    .join(enter => enter.append("g").attr("class","leftG")
      .attr("transform", d=>`translate(0,${y(d.age)})`)
      .attr("data-y", d=>y(d.age))
      .call(g=>g.append("rect").attr("class","bar-left")
        .attr("height", y.bandwidth())
        .attr("rx", Math.min(18, y.bandwidth() / 2))
        .attr("ry", Math.min(18, y.bandwidth() / 2))
        .attr("fill", "url(#gradL)")
        .attr("opacity", 1)
      )
    );
  leftRow.attr("transform", d=>`translate(0,${y(d.age)})`).attr("data-y", d=>y(d.age));
  leftRow.select("rect")
    .attr("x", d => xAll(-d.male))
    .attr("width", d => xAll(0) - xAll(-d.male))
    .attr("height", y.bandwidth())
    .attr("opacity", 1);

  const rightRow = rightG.selectAll("g.rightG").data(state.data, d=>d.age)
    .join(enter => enter.append("g").attr("class","rightG")
      .attr("transform", d=>`translate(0,${y(d.age)})`)
      .attr("data-y", d=>y(d.age))
      .call(g=>g.append("rect").attr("class","bar-right")
        .attr("x", xRight(0))
        .attr("height", y.bandwidth())
        .attr("rx", Math.min(18, y.bandwidth() / 2))
        .attr("ry", Math.min(18, y.bandwidth() / 2))
        .attr("fill", "url(#gradR)")
        .attr("opacity", 1)
      )
    );
  rightRow.attr("transform", d=>`translate(0,${y(d.age)})`).attr("data-y", d=>y(d.age));
  rightRow.select("rect")
    .attr("x", xAll(0))
    .attr("width", d => xAll(d.female) - xAll(0))
    .attr("height", y.bandwidth())
    .attr("rx", Math.min(18, y.bandwidth() / 2))
    .attr("ry", Math.min(18, y.bandwidth() / 2));

  // remove any center labels if present
  g.selectAll(".age-label").remove();

  // Ensure bars sit above grid/axes
  leftG.raise();
  rightG.raise();
  addHover();
  drawValuesIfNeeded();
}

function drawValuesIfNeeded(centerOnly=false){
  valueG.selectAll("*").remove();
  if (!state.showValues) return;
  valueG.raise();
  const large = maxVal >= 1e6;
  const f = large ? fmtShort : fmt;
  const fs = large ? 10 : 12;
  valueG.selectAll("text.val").data(state.data, d=>d.age).join("text")
    .attr("class","val")
    .attr("font-size", fs).attr("font-weight", 700)
    .attr("fill", "var(--text)")
    .attr("stroke","#fff").attr("stroke-width",3).attr("paint-order","stroke")
    .attr("text-anchor", "middle")
    .attr("x", iw/2).attr("y", d=>y(d.age)+y.bandwidth()/2+4)
    .text(d => `${f(d.male)} • ${f(d.female)}`);
}

/* INTERACTIONS (hover, focus, click)
   Makes the chart react to mouse and keyboard for basic exploration. */
function addHover(){
  if (state.data.length > 800) return; // only skip on extremely large datasets
  const leftItems = g.selectAll('g.leftG');
  const rightItems = g.selectAll('g.rightG');

  leftItems.attr('tabindex', 0)
    .attr('role','button')
    .attr('aria-label', d => `${d.age}. ${sideLeftLabel} ${d.male}. ${sideRightLabel} ${d.female}.`)
    .on('mouseenter', function(event, d){ showTip(event, d, 'left'); })
    .on('mousemove', e => { moveTip(e); })
    .on('mouseleave', function(){ hideTip(); })
    .on('click', function(event, d){ hideTip(); openDetail(d); });

  rightItems.attr('tabindex', 0)
    .attr('role','button')
    .attr('aria-label', d => `${d.age}. ${sideLeftLabel} ${d.male}. ${sideRightLabel} ${d.female}.`)
    .on('mouseenter', function(event, d){ showTip(event, d, 'right'); })
    .on('mousemove', e => { moveTip(e); })
    .on('mouseleave', function(){ hideTip(); })
    .on('click', function(event, d){ hideTip(); openDetail(d); });
  // Hide tooltip when leaving the SVG/chart entirely
  svg.on('mouseleave', () => hideTip());
}

/* ---------------------- Update pipeline ---------------------- */
function render(){
  updateScales();
  drawAxes();
  clearMode();
  renderBars();

  // simple guard: if many categories, reduce hover bindings
  if (state.data.length > 120){
    setStatus('Showing many categories — interactivity reduced for performance.');
  }
}

/* Decorative bubbles removed for simplified single-mode chart */

/* UI WIRING
   Detail view and sort controls. Theme is chosen via initialMode
   in the editable config section above, not by an on-page toggle. */
// detail view wiring
try{
  document.getElementById('detailBack').addEventListener('click', closeDetail);
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeDetail(); });
}catch(e){}

/* CSV upload removed */

function getBaseData(){
  // Always work from whatever is currently in state.data so external
  // files (CSV/JSON) or demoData both flow through the same path.
  return structuredClone(state.data);
}

function applyLimitForView(){
  setStatus('');
  state.data = getBaseData();
  updateTheme(state.theme);
  // respect current sort preference using shared helper
  applySort();
  render();
  // Explain what subset + ordering the user is seeing.
  updateStatusMessage();
  if (typeof updateSortButton === 'function') updateSortButton();
}

// Sorting: button and Shift+D both toggle
function applySort(){
  const arr = [...state.data];
  if (state.sortByDiff){
    arr.sort((a,b)=>Math.abs(b.male-b.female)-Math.abs(a.male-a.female));
  } else {
    arr.sort((a,b)=> d3.ascending(a.age, b.age));
  }
  state.data = arr;
}
function updateSortButton(){
  const btn = document.getElementById('sortBtn');
  if (!btn) return;
  // When sortByDiff is true the data is sorted by gap, otherwise A–Z.
  btn.textContent = state.sortByDiff ? 'Sorted by Diff' : 'Sorted A–Z';
  btn.setAttribute('aria-pressed', String(state.sortByDiff));
}
const sortBtn = document.getElementById('sortBtn');
if (sortBtn){
  sortBtn.addEventListener('click', ()=>{
    state.sortByDiff = !state.sortByDiff;
    applySort();
    render();
    updateSortButton();
    updateStatusMessage();
  });
}
document.addEventListener('keydown', (e)=>{
  if (e.shiftKey && (e.key==='D' || e.key==='d')){
    state.sortByDiff = !state.sortByDiff;
    applySort();
    render();
    updateSortButton();
    updateStatusMessage();
  }
});


/* Respect reduced motion */
if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) document.body.style.animation="none";

/* Initial theme + render (use the theme you set above) */
updateTheme(state.theme, false);

// Load external data (CSV/JSON). If the config is empty or loading
// fails, this quietly falls back to the built-in demoData above.
loadData().then(rows => {
  state.data = rows;
  applyLimitForView();
});

/* Fade-in */
svg.style("opacity",0).transition().duration(800).ease(d3.easeCubicOut).style("opacity",1);
</script>
</body>
</html>
